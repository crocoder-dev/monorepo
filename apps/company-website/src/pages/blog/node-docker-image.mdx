import blogHeader from "../../content/images/blogs/best-react-component-libraries-2022.jpg?preset=responsive";
import BlogLayout from "../../Layouts/BlogLayout";
import ContentTable from "../../components/Blog/ContentTable";

export const meta = {
  id: "node-docker-image",
  title:
    "BLAZINGLY FAST Node.js app in Docker",
  description:
    "",
  category: "Docker",
  image: blogHeader,
  date: 1678659672751,
  updatedAt: 1678659672751,
  author: "davidabram",
  editor: "velimirujevic",
  abstract:
    "",
  pageType: "blog-posting"
};

<ContentTable tocData={props.toc} />

## Explicitly set Docker base image tag

If you set a tag for your base image, it ensures that the same image will always be used when building your Docker image. This means that your Docker image will behave consistently no matter where it is used.

I personally suggest using the latest LTS or current version of Node.js pinned to the minor version (as of March 13th that would be 18.15 or 19.7). This way you will always get the latest security patches and bug fixes, but still have a consistent build.

I recommend using the Alpine version of the Node.js image. This version is smaller and faster to build compared to the default Debian-based image. 

Additionally, using a smaller image reduces the attack surface area, making it more difficult for attackers to exploit vulnerabilities. This approach also helps prevent issues that could occur from updates to the base image that may cause problems with our application.

When we apply all this, we get a Dockerfile that looks like

```docker
FROM node:19.7-alpine3.16

COPY . .

RUN npm install

CMD "npm" "start"
```

## Don't use npm script to run your node app


```javascript
const http = require('http');

function handle(signal) {
  console.log(`Received signal: ${signal}`);
}
process.on('SIGHUP', handle);

const server = http.createServer();

server.listen(3000);
```

```json
{
  "scripts": {
    "start": "node index.js"
  }
}
```

```docker
FROM node:19.7-alpine3.16

COPY . .

RUN npm install

CMD "npm" "start"
```

```bash
docker build . -t npm-start-test-image

docker run -d --name npm-start-test-container npm-start-test

docker kill --signal=SIGHUP npm-start-test-container
```

```docker
FROM node:19.7-alpine3.16

COPY . .

RUN npm install

CMD "node" "server.js"
```

## Specify what files and where should be copied

## Run containers as a non-root user

## Set NODE_ENV=production

## Use Cache Mounts

## Use multi-stage builds

## Properly mount secrets into Docker image

```docker
FROM node

COPY . .

RUN npm install

CMD ["npm", "run", "dev"]
```


```docker
# Start with a base image that has Node.js installed
FROM node

# Copy the contents of the current directory (where the Dockerfile is located) 
# into the container's file system
COPY . .

# Run the "npm install" command inside the container to install any required 
# Node.js packages specified in the "package.json" file.
RUN npm install

# Define the command that will be executed when the container is started
# This will start the Node.js application using the "npm run dev" command.
CMD ["npm", "run", "dev"]
```

```docker
FROM node:19.7-alpine3.16

COPY . .

RUN npm install

CMD ["npm", "run", "dev"]
```


```docker
FROM node:19.7-alpine3.16

WORKDIR /usr/src/app

COPY package*.json ./

RUN npm install

COPY ./src/ .

CMD ["npm", "run", "dev"]
```

```docker
FROM node:19.7-alpine3.16

WORKDIR /usr/src/app

COPY package*.json ./

RUN npm install

COPY ./src/ .

USER node

COPY --chown=node:node ./src/ .

CMD ["npm", "run", "dev"]
```

```docker
FROM node:19.7-alpine3.16

ENV NODE_ENV production

WORKDIR /usr/src/app

COPY package*.json ./

RUN npm ci --only-production
   
COPY ./src/ .

USER node

COPY --chown=node:node ./src/ .

EXPOSE 3000

CMD ["npm", "run", "dev"]
```

```docker
FROM node:19.7-alpine3.16

ENV NODE_ENV production

WORKDIR /usr/src/app

COPY package*.json ./

RUN npm ci --only-production
   
COPY ./src/ .

USER node

COPY --chown=node:node ./src/ .

RUN npm install

CMD ["npm", "run", "dev"]
```

```docker
FROM node:19.7-alpine3.16

ENV NODE_ENV production

WORKDIR /usr/src/app

COPY package*.json ./

RUN --mount=type=cache,target=/usr/src/app/.npm \
  npm set cache /usr/src/app/.npm && \
  npm ci --only=production
   
COPY ./src/ .

USER node

COPY --chown=node:node ./src/ .

RUN npm install

CMD ["npm", "run", "dev"]
```

```docker
FROM node:19.6-bullseye-slim AS base

WORKDIR /usr/src/app

COPY package*.json ./

FROM base as dev

RUN --mount=type=cache,target=/usr/src/app/.npm \
  npm set cache /usr/src/app/.npm && \
  npm install

COPY . .

CMD ["npm", "run", "dev"]

FROM base as production

ENV NODE_ENV production

RUN --mount=type=cache,target=/usr/src/app/.npm \
  npm set cache /usr/src/app/.npm && \
  npm ci --only=production

USER node

COPY --chown=node:node ./src/ .

EXPOSE 3000

CMD ["npm", "run", "dev"]
```

https://hub.docker.com/_/node

export default (props) => <BlogLayout meta={meta} {...props}>{props.children}</BlogLayout>;